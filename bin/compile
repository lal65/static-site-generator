#!/usr/bin/env php
<?php

use League\CommonMark\Extension\FrontMatter\Data\LibYamlFrontMatterParser;
use League\CommonMark\Extension\FrontMatter\FrontMatterParser;
use ooe\Functions\Config;
use ooe\Functions\Favicons;
use ooe\Functions\Menus;
use ooe\Functions\Styles;
use Twig\Environment;
use Twig\Extra\Markdown\DefaultMarkdown;
use Twig\Extra\Markdown\MarkdownExtension;
use Twig\Extra\Markdown\MarkdownRuntime;
use Twig\Loader\FilesystemLoader;
use Twig\RuntimeLoader\RuntimeLoaderInterface;
use Twig\TwigFilter;
use Twig\TwigFunction;

include $_composer_autoload_path ?? __DIR__ . '/../vendor/autoload.php';

if (!file_exists('dist')) {
  mkdir('dist' . DIRECTORY_SEPARATOR . 'images', 0777, TRUE);
}

$vendor_pkg = 'vendor' . DIRECTORY_SEPARATOR . 'psu-ooe' . DIRECTORY_SEPARATOR . 'static-site-generator';
if (file_exists($vendor_pkg))
exec("cd $vendor_pkg && npm install");

$paths = array_filter([
  'blocks',
  'templates',
  'vendor' . DIRECTORY_SEPARATOR . 'psu-ooe' . DIRECTORY_SEPARATOR . 'static-site-generator' . DIRECTORY_SEPARATOR . 'blocks',
  'vendor' . DIRECTORY_SEPARATOR . 'psu-ooe' . DIRECTORY_SEPARATOR . 'static-site-generator' . DIRECTORY_SEPARATOR . 'templates',
], static fn($path) => file_exists($path));

$loader = new FilesystemLoader($paths);
$paths = array_filter([
  'node_modules/@psu-ooe',
  'vendor' . DIRECTORY_SEPARATOR . 'psu-ooe' . DIRECTORY_SEPARATOR . 'static-site-generator' . DIRECTORY_SEPARATOR . 'node_modules' . DIRECTORY_SEPARATOR . '@psu-ooe',
], static fn($path) => file_exists($path));

foreach ($paths as $path) {
  if (file_exists($path)) {
    $loader->addPath($path, 'psu-ooe');
    break;
  }
}

$twig = new Environment($loader);

$twig->addExtension(new MarkdownExtension());
$twig->addRuntimeLoader(new class implements RuntimeLoaderInterface {
  public function load($class) {
    if (MarkdownRuntime::class === $class) {
      return new MarkdownRuntime(new DefaultMarkdown());
    }
  }
});

$twig->addFilter(new TwigFilter('clean_unique_id', static function($id) {
  $id = str_replace(' ', '-', $id);
  return $id . '-' . uniqid();
}));

$twig->addFunction(new TwigFunction('get_config', Config::class . '::getConfig'));
$twig->addFunction(new TwigFunction('get_styles', Styles::class . '::getStyles'));
$twig->addFunction(new TwigFunction('render_favicons', Favicons::class . '::renderFavicons'));
$twig->addFunction(new TwigFunction('get_menu_items', Menus::class . '::getMenuItems'));

$frontMatterParser = new FrontMatterParser(new LibYamlFrontMatterParser());

foreach (new RecursiveIteratorIterator(new RecursiveDirectoryIterator('pages', FilesystemIterator::SKIP_DOTS), RecursiveIteratorIterator::SELF_FIRST) as $page) {
  $dest = 'dist' . DIRECTORY_SEPARATOR . preg_replace('/^pages\//', '', $page->getPathname());
  if ($page->isDir()) {
    continue;
  }
  $content = file_get_contents($page);
  $result = $frontMatterParser->parse($content);
  $frontmatter = $result->getFrontMatter();

  $context = yaml_parse(file_get_contents('config.yml'));
  if (is_array($frontmatter)) {
    $context += $frontmatter;
  }

  $blocks = [];
  foreach (glob('blocks/*') as $region) {
    $region_name = basename($region);
    foreach (glob("$region/*.twig") as $block) {
      $block_name = basename($block);
      $blocks[$region_name][$block_name] = $twig->render($region_name . DIRECTORY_SEPARATOR . $block_name, $context);
    }
  }

  $context['blocks'] = $blocks;
  $context['content'] = $result->getContent();

  if (isset($context['page_image'])) {
    $imagick = new IMagick();
    $imagick->readImage('images/' . $context['page_image']);
    foreach ([[1920, 1280], [1280, 720], [768, 432]] as $resolution) {
      $derivative = clone $imagick;
      $derivative->scaleImage($resolution[0], $resolution[1]);
      $derivative->setImageFormat('webp');
      $derivative->writeImage('dist/images/' . $context['page_image'] . '@' . $resolution[0] . 'x' . $resolution[1] . '.webp');
    }
  }
  echo $dest . PHP_EOL;

  if (!file_exists(dirname($dest))) {
    mkdir(dirname($dest), 0777, TRUE);
    echo 'Made...' . $dest;
  }

  file_put_contents(preg_replace('/\.md$/', '.html', $dest), $twig->render('page.twig', $context));
}